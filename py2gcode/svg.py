# -*- coding: utf-8 -*-

from trajectory import *
from bezier import *

path_commands = ['m',  'c',  'l', 'M',  'C',  'L',  'z', 'Z'] #доступные команды


class SvgTrajectory(Trajectory):
    def __init__(self, str):
        super(SvgTrajectory,  self).__init__()
        self.src = str
        self.commands = parse_full_svg(str)        
        self.points = []

    def __str__(self):
        res = ""
        for c in self.commands:
            res += c['com'] 
            for x, y in c['params']:
                res += " (%f,%f)" % (x, y)
            res += "\n"
        return res

    def create_trajectory(self):
        if len(self.points) > 0:
            return
        
        self.points = []        
        curr_x, curr_y = 0, 0
        begin = None #точку, куда будем замыкать траекторию
        #print self.commands
        for c in self.commands:
            path = []
            ok = False
            if c['com'] in ['m', 'M']:
                path, x, y = self.__move(c, curr_x, curr_y)            
                ok = True
            if begin == None: begin = (path[0]['x'], path[0]['y'])

            if c['com'] in ['l', 'L']:
                path, x, y = self.__line(c, curr_x, curr_y)
                ok = True

            if c['com'] in ['c', 'C']:
                path, x, y = self.__curve(c, curr_x, curr_y)
                ok = True

            if c['com'] in ['z', 'Z']:
                self.points.append({'x': begin[0], 'y': begin[1]})
                begin = None
                ok = True

            if ok == False:
                print c
            
            curr_x = x
            curr_y = y
            self.points += path
        self.update_offsets()
        #print self.points


    def __curve(self, command, x, y):
        com = command['com']
        params = command['params']
        path = []
        cx, cy = x, y
        prev = (x, y)

        ts = [t/10.0 for t in range(11)]
        d = 3

        if com == 'c':
            while len(params) >=3:
                #берем три точки кривой                
                xys  = params[:3]
                #к каждой точке прибавляем абсолютное значение
                xys = map(lambda (_x, _y): (_x + cx, _y + cy), xys)
                #в начало гладем абсолютное значение
                xys = [prev] + xys
                #генерим траеторию

                bezier = make_bezier(xys)
                points = bezier(ts)
                for xx, yy in points:
                    path.append({'x': xx, 'y': yy})

                #path.append({'x': xx, 'y': yy})               

                xx, yy = xys[3]
                prev = (xx, yy)
                #новые абсолютные значения
                cx = xx
                cy = yy
                params = params[3:]

        return path, cx, cy
        

    def __line(self, command, x, y):
        com = command['com']
        params = command['params']

        #тоже самое, что и move, только координата лишняя
        if com == 'L': #как будто движение, но с нуля
            return self.__move({'com': 'M', 'params': [(0, 0)] + params}, x, y)
        if com == 'l': #как будто движение, но с нуля
            return self.__move({'com': 'm', 'params': [(0, 0)] + params}, x, y)

    def __move(self, command, x, y):
        '''отрабатываем команду "m", возвращает список точек{x, y} в абсолютных координатах
        возвращает новые текущие координаты (x, y)'''
        com = command['com']
        params = command['params']
        (xx, yy) = params[0] #текущие координаты
        xx += x
        yy += y
        res = [{'x': xx, 'y': yy}]
        if len(params) == 1: #просто изменение текущих координат
            return res, xx, yy

        #дано несколько координат
        for p in params[1:]:
            if com == 'm':
                nx, ny = p
                xx += nx
                yy += ny
                res.append({'x': xx, 'y': yy})
                
            if com == 'M':
                nx, ny = p
                xx = nx
                yy = ny
                res.append({'x': xx, 'y': yy})
        return res, xx, yy        

    def command_to_coord(self):
        pass

    
def parse_params(params):
    'парсит строку параметров (координаты точек) в массив'
    vertex = params.split(' ') #разделили на вершины (они через пробел)
    #каждую вершину - на x и y
    res = []
    for v in vertex:
        if len(v) > 0:
            x, y = v.split(',')
            res.append((float(x), float(y)))
    return res

def parse_full_svg(str_svg_path):
    'разбивает строку на массив команд: {com, params}'
    res = []
    curr = ""
    curr_command = ""
    for s in str_svg_path:
        if s in path_commands: #встретилась команда
            if curr_command != "":    #если в данный момент проходили какую-то команду
                res.append({'com': curr_command,  'params': parse_params(curr.strip())})    #сохраняем ее как результат
                curr = ""
            curr_command = s            #и переходим к новой
        else:
            curr += s
    if curr_command != "":
        res.append({'com': curr_command, 'params': parse_params(curr.strip())}) #последнюю подстроку
    return res

if __name__ == '__main__':
    #str = "m 17,18 46,-110 103,31 44,154 z"
    str = "m 27.178679,35.394722 -1.855469,5.097656 -15.6250002,0 0,-0.722656 c 4.5963482,-4.192703 7.8320222,-7.617179 9.7070312,-10.273438 1.874988,-2.656236 2.812487,-5.084619 2.8125,-7.285156 -1.3e-5,-1.679667 -0.514336,-3.059874 -1.542969,-4.140625 -1.028656,-1.080705 -2.259124,-1.621069 -3.691406,-1.621094 -1.30209,2.5e-5 -2.470709,0.380884 -3.505859,1.142579 -1.03516,0.76174 -1.800133,1.878276 -2.294922,3.349609 l -0.722656,0 c 0.325518,-2.408832 1.162106,-4.257789 2.509765,-5.546875 1.347651,-1.289036 3.030592,-1.933567 5.048828,-1.933594 2.148426,2.7e-5 3.942044,0.690131 5.38086,2.070313 1.438786,1.380232 2.158186,3.007834 2.158203,4.882812 -1.7e-5,1.341165 -0.312517,2.682309 -0.9375,4.023438 -0.963557,2.109389 -2.526055,4.342459 -4.6875,6.699218 -3.242196,3.541673 -5.266933,5.677087 -6.074219,6.40625 l 6.914063,0 c 1.406236,3e-6 2.392563,-0.05208 2.958984,-0.15625 0.566391,-0.104163 1.077458,-0.315751 1.533203,-0.634765 0.455712,-0.319006 0.852847,-0.77148 1.191406,-1.357422 z"
    f_1="m 90.401787,85.618324 6.445312,-3.144531 0.644532,0 0,22.363277 c -1.2e-5,1.48438 0.06184,2.40886 0.185546,2.77344 0.123686,0.36459 0.380847,0.64453 0.771485,0.83985 0.390612,0.19531 1.184882,0.30599 2.382808,0.33203 l 0,0.72265 -9.960933,0 0,-0.72265 c 1.249993,-0.026 2.057284,-0.13347 2.421875,-0.32227 0.364575,-0.1888 0.618481,-0.44271 0.761719,-0.76172 0.14322,-0.31901 0.214835,-1.27278 0.214843,-2.86133 l 0,-14.296871 c -8e-6,-1.927062 -0.06511,-3.16404 -0.195312,-3.710937 -0.09115,-0.416644 -0.25717,-0.722633 -0.498047,-0.917969 -0.240893,-0.195289 -0.530606,-0.292945 -0.869141,-0.292969 -0.481777,2.4e-5 -1.152349,0.201847 -2.011718,0.605469 z"
    f_2="m 124.05413,104.40739 -1.85547,5.09765 -15.625,0 0,-0.72265 c 4.59635,-4.19271 7.83202,-7.61718 9.70703,-10.273441 1.87499,-2.656236 2.81249,-5.084619 2.8125,-7.285156 -1e-5,-1.679668 -0.51433,-3.059874 -1.54297,-4.140625 -1.02865,-1.080706 -2.25912,-1.62107 -3.6914,-1.621094 -1.30209,2.4e-5 -2.47071,0.380883 -3.50586,1.142578 -1.03516,0.761741 -1.80013,1.878277 -2.29492,3.34961 l -0.72266,0 c 0.32552,-2.408832 1.16211,-4.257789 2.50977,-5.546875 1.34765,-1.289036 3.03059,-1.933567 5.04882,-1.933594 2.14843,2.7e-5 3.94205,0.690131 5.38086,2.070313 1.43879,1.380231 2.15819,3.007834 2.15821,4.882812 -2e-5,1.341165 -0.31252,2.682309 -0.9375,4.023438 -0.96356,2.109388 -2.52606,4.342459 -4.6875,6.699214 -3.2422,3.54168 -5.26694,5.67709 -6.07422,6.40625 l 6.91406,0 c 1.40624,1e-5 2.39256,-0.0521 2.95898,-0.15625 0.5664,-0.10416 1.07746,-0.31575 1.53321,-0.63476 0.45571,-0.31901 0.85285,-0.77148 1.1914,-1.35742 z"
    f_3="m 127.74554,88.059731 c 0.7552,-1.783831 1.70898,-3.160783 2.86132,-4.13086 1.15234,-0.970025 2.58789,-1.455051 4.30665,-1.455078 2.12238,2.7e-5 3.74998,0.690131 4.88281,2.070313 0.85936,1.028669 1.28905,2.128929 1.28906,3.300781 -10e-6,1.927103 -1.21095,3.919288 -3.63281,5.976562 1.62759,0.638036 2.85806,1.549494 3.6914,2.734375 0.83332,1.184908 1.24999,2.578136 1.25,4.179686 -1e-5,2.29167 -0.72918,4.27735 -2.1875,5.95703 -1.90105,2.1875 -4.65495,3.28125 -8.26171,3.28125 -1.78386,0 -2.99805,-0.22135 -3.64258,-0.66406 -0.64454,-0.44271 -0.9668,-0.91797 -0.9668,-1.42578 0,-0.3776 0.15299,-0.70963 0.45898,-0.99609 0.30599,-0.28646 0.67383,-0.42969 1.10352,-0.42969 0.32552,0 0.65755,0.0521 0.99609,0.15625 0.22135,0.0651 0.72266,0.30273 1.50391,0.71289 0.78124,0.41016 1.32161,0.6543 1.62109,0.73242 0.48177,0.14323 0.99609,0.21485 1.54297,0.21484 1.32812,1e-5 2.48372,-0.51432 3.4668,-1.54296 0.98306,-1.02865 1.4746,-2.24609 1.47461,-3.65235 -1e-5,-1.02864 -0.22788,-2.03124 -0.68359,-3.00781 -0.33856,-0.729157 -0.70965,-1.282542 -1.11329,-1.660157 -0.5599,-0.520822 -1.32813,-0.992826 -2.30468,-1.416016 -0.97657,-0.423164 -1.97267,-0.634752 -2.98828,-0.634765 l -0.625,0 0,-0.585938 c 1.02863,-0.130194 2.06053,-0.501288 3.0957,-1.113281 1.03514,-0.611964 1.7871,-1.34764 2.25586,-2.207031 0.46874,-0.859357 0.70311,-1.803367 0.70312,-2.832031 -1e-5,-1.341125 -0.41993,-2.425108 -1.25976,-3.251954 -0.83986,-0.826799 -1.88478,-1.24021 -3.13477,-1.240234 -2.01823,2.4e-5 -3.70443,1.080752 -5.05859,3.242188 z"
    f_sch = "m 152.13109,111.91016 0,-0.72266 c 0.0651,-0.013 0.30599,-0.0391 0.72265,-0.0781 1.00261,-0.0781 1.70247,-0.32552 2.09961,-0.74219 0.39713,-0.41667 0.5957,-1.51693 0.59571,-3.30078 l 0,-16.81641 c -1e-5,-1.705706 -0.2116,-2.7962 -0.63477,-3.271484 -0.42318,-0.475235 -1.35091,-0.751928 -2.7832,-0.830079 l 0,-0.722656 10.15625,0 0,0.722656 c -1.27605,0.130234 -2.09311,0.439479 -2.45117,0.927735 -0.35808,0.488305 -0.53712,1.546247 -0.53711,3.173828 l 0,16.81641 c -1e-5,1.34115 0.0488,2.19075 0.14648,2.54882 0.0977,0.35808 0.26041,0.5892 0.48828,0.69336 0.22786,0.10417 0.75195,0.15626 1.57227,0.15625 l 5.15625,0 c 1.30206,1e-5 2.07029,-0.10416 2.30469,-0.3125 0.23435,-0.20833 0.35154,-1.23697 0.35156,-3.08593 l 0,-16.81641 c -2e-5,-1.588518 -0.1758,-2.636694 -0.52735,-3.144531 -0.35158,-0.507787 -1.1784,-0.826798 -2.48046,-0.957032 l 0,-0.722656 9.74609,0 0,0.722656 c -1.28909,0.130234 -2.1094,0.445989 -2.46094,0.947266 -0.35158,0.501327 -0.52736,1.552758 -0.52734,3.154297 l 0,16.81641 c -2e-5,1.71875 0.11065,2.71484 0.33203,2.98828 0.22133,0.27344 1.06117,0.41016 2.51953,0.41015 l 5.25391,0 c 0.71611,1e-5 1.18486,-0.0618 1.40625,-0.18554 0.22132,-0.1237 0.36129,-0.30925 0.41992,-0.55664 0.0586,-0.2474 0.0879,-1.13281 0.0879,-2.65625 l 0,-16.81641 c -3e-5,-1.61456 -0.17907,-2.669247 -0.53711,-3.164063 -0.3581,-0.494766 -1.18167,-0.807266 -2.4707,-0.9375 l 0,-0.722656 10.11718,0 0,0.722656 c -0.96358,0.02607 -1.68949,0.169297 -2.17773,0.429688 -0.48832,0.260442 -0.80733,0.62828 -0.95703,1.103516 -0.14978,0.475284 -0.22465,1.331403 -0.22461,2.568359 l 0,16.81641 c -4e-5,1.36719 0.0586,2.23958 0.17578,2.61718 0.11715,0.37761 0.37106,0.71941 0.76172,1.02539 0.39059,0.30599 1.21741,0.4655 2.48047,0.47852 l 0,8.33984 -0.66406,0 c -0.54692,-2.17448 -1.23702,-3.79232 -2.07032,-4.85351 -0.83337,-1.0612 -1.80993,-1.78711 -2.92968,-2.17774 -1.11983,-0.39062 -2.76045,-0.58593 -4.92188,-0.58593 z"


    _1 = SvgTrajectory(f_1)
    _1.jump_point(5, [6, 55])
    _2 = SvgTrajectory(f_2)
    _2.jump_point(5, [10, 63])
    _3 = SvgTrajectory(f_3)
    _3.jump_point(5, [10, 45])
    _sch = SvgTrajectory(f_sch)
    _sch.jump_point(5, [14, 41, 68, 93])

    preview2D([_1, _2, _3, _sch], 8)
    
    def one(f):
        x,  y =  f.get_first_position()
        G0(x, y)

        z = -3

        while z>-5:
            f.to_gcode(z,  -3.5)
            z -= 0.5
        G0(Z = 3)

    def f():
        F(300)
        G0(0, 0, 5)
        F(1000)

        for p in [_1, _2, _3, _sch]:
            one(p)

        G0(Z=5)

    #preview(f)
